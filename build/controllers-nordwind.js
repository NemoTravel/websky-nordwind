!function(){function e(r,n,o){function a(t,i){if(!n[t]){if(!r[t]){var c="function"==typeof require&&require;if(!i&&c)return c(t,!0);if(s)return s(t,!0);var d=new Error("Cannot find module '"+t+"'");throw d.code="MODULE_NOT_FOUND",d}var l=n[t]={exports:{}};r[t][0].call(l.exports,function(e){var n=r[t][1][e];return a(n||e)},l,l.exports,e,r,n,o)}return n[t].exports}for(var s="function"==typeof require&&require,t=0;t<o.length;t++)a(o[t]);return a}return e}()({1:[function(e,r,n){"use strict";function o(e){var r=this;r.isCommonService=e.isCommonServiceCode}var a=angular.module("app");a.component("nwExtraServicesList",{templateUrl:"components/nw-extra-services-list/nw-extra-services-list.html",controller:"extraServicesListController",controllerAs:"vm",bindings:{es:"=es",list:"=list",availableBundlesByPassengerSegments:"<",locked:"=locked"}}),a.controller("extraServicesListController",["utils",o])},{}],2:[function(e,r,n){"use strict";function o(e,r,n){function o(){t&&(t(!0),a())}function a(){jQuery.fancybox.close()}var s=this,t=!1;s.close=a,s.submit=o,s.popupId="#nw-"+s.esCode+"-popup",n.setOpenListener("nw-"+s.esCode+"-popup",function(e,r){var n=angular.element(s.popupId),o=n.parents(".fancybox-wrap");o.hasClass("extra-service__popup")||o.addClass("extra-service__popup")})}angular.module("app").component("nwEsPopup",{templateUrl:"components/nw-meal-popup/nw-meal-popup.html",controller:"nwMealPopupController",bindToController:!0,controllerAs:"vm",bindings:{locked:"=",esCode:"<",es:"="},transclude:{"extra-service":"wrap"}}),angular.module("app").controller("nwMealPopupController",["$scope","backend","fancyboxTools",o])},{}],3:[function(e,r,n){"use strict";function o(e,r,n,o){function a(){h.locked||n.checkServiceRemovalProhibited("meal")||(h.service.active=!h.service.active,h.service.active?t():n.removeExtraService({code:"meal"}),h.closePopup())}function s(e,r){h.selectedFlight=e,h.selectedPassenger=r,i()}function t(){h.selectedFlight=m(),h.selectedPassenger=g(h.selectedFlight),i()}function i(){h.mealMenu=h.service.itemsByPassengerSegments[h.selectedPassenger][h.selectedFlight],h.mealMenuSubgroup=!1}function c(e,r,o){h.locked||n.modifyExtraService({code:"meal",passenger_id:h.orderInfo.passengers[h.selectedPassenger].id,segment_id:h.orderInfo.plainFlights[h.selectedFlight].id,subgroup:h.service.subgroups[e],amount:(r.alreadySelectedCount||0)+o,rfisc:r.rfisc})}function d(e,r){h.locked||n.checkServiceRemovalProhibited("meal",e,r)||n.removeExtraService({code:"meal",passenger_id:h.orderInfo.passengers[e].id,segment_id:h.orderInfo.plainFlights[r].id})}function l(e,r){var n,o=0,a=0;return h.orderInfo.groupedEditableExtraServices&&h.orderInfo.groupedEditableExtraServices.meal&&h.orderInfo.groupedEditableExtraServices.meal[e]&&h.orderInfo.groupedEditableExtraServices.meal[e][r]&&h.orderInfo.groupedEditableExtraServices.meal[e][r].length&&h.orderInfo.groupedEditableExtraServices.meal[e][r].forEach(function(e){e.amount&&(o+=e.amount),e.totalPrice&&(a=Big(a).plus(e.totalPrice).toFixed(2),n=e.currency)}),o?{count:o,cost:a,currency:n}:!1}function u(){v.scrollTo(0)}function f(){v.scrollTo(v[0].scrollWidth)}function p(){var r=v[0].scrollLeft,n=v[0].scrollWidth,o=v[0].clientWidth,a=n-o-r;h.canScrollRight=0!==a,h.canScrollLeft=0!==r,e.$apply()}function m(){var e;for(e=0;e<h.orderInfo.plainFlights.length;e++)if(h.service.availableBySegments[e])return e;return-1}function g(e){var r;if(h.service.availableByPassengerSegments)for(r=0;r<h.orderInfo.passengers.length;r++)if(h.service.availableByPassengerSegments[r][e])return r;return-1}var h=this,v=r.find("div.passengersTableContainer");h.switchService=a,h.selectFlightPassenger=s,h.selectFirstAvailablePassengerFlight=t,h.mealCountChangeHandler=c,h.removePassengerFlightMeal=d,h.getSelectedPassengerFlightMeal=l,h.scrollToStart=u,h.scrollToEnd=f,h.hasAlias=n.hasAlias,h.getAvailablePassengersCount=o.getAvailablePassengersCount,h.checkServiceRemovalProhibited=n.checkServiceRemovalProhibited,h.closePopup=h.closePopup(),h.canScrollRight=!0,h.canScrollLeft=!1,h.selectedFlight=0,h.selectedPassenger=0,n.getParam("site.externalStorageBaseUrl")?h.mealImagesPath=n.getParam("site.externalStorageBaseUrl")+"/img/content/meal":h.mealImagesPath="./themes/websky/assets/static/img/content/meal",n.addOrderInfoListener(function(e){h.orderInfo=e},!1,!0),e.$watch("vm.service",function(){i()}),v.on("scroll",p),h.service.active&&i()}var a=angular.module("app");a.component("nwMeal",{templateUrl:"components/nw-meal/nw-meal.html",controller:["$scope","$element","backend","utils",o],controllerAs:"vm",bindings:{service:"=service",locked:"=locked",closePopup:"&"}})},{}],4:[function(e,r,n){"use strict";function o(e,r,n,o,a,s,t,i){function c(e){f.loading=!0,o.retryRegister(e).then(function(e){e.pnr&&e.lastName?r.location="./order?pnr="+e.pnr+"&lastName="+e.lastName:(e.eraseAeroexpressBecauseOfCurrency||e.eraseInsuranceBecauseOfCurrency)&&t.openHandler("popupChangeCurrencyError",!1,{eraseAeroexpressBecauseOfCurrency:e.eraseAeroexpressBecauseOfCurrency,eraseInsuranceBecauseOfCurrency:e.eraseInsuranceBecauseOfCurrency,mode:"retryRegister",submitCallback:c}),f.loading=!1},function(e){f.loading=!1,f.errorMessage=e.error})}function d(){f.orderInfo.header&&f.orderInfo.header.regnum&&f.orderInfo.header.lastName&&(f.loading=!0,o.bindOrder(f.orderInfo.header.regnum,f.orderInfo.header.lastName).then(function(){f.loading=!1,f.orderInfo.bindAlowed=!1,f.showBindOrderSuccessMessage=!0,n(function(){f.showBindOrderSuccessMessage=!1},1e4)},function(){f.loading=!1,f.showBindOrderFailMessage=!0,n(function(){f.showBindOrderFailMessage=!1},1e4)}))}function l(){o.clearSession().then(function(){s.goToSearchOrder()})}function u(){o.clearLastSearchParams().then(function(){r.location=o.getAlias("web.site.firstStepUrl")})}var f=this;f.loading=!0,f.errorMessage=!1,f.choosePayMethodFailMsg=!1,f.tabId=i(),f.openExchange=s.goToExchange,f.openRefund=s.goToRefund,f.openAddServices=s.goToAddServices,f.suffixCount=a.suffixCount,f.retryPayment=c,f.bindOrder=d,f.clearSession=l,f.newBooking=u,e.$on("popupChoosePayMethodChoosePayMethodFailMsg",function(e,r){f.choosePayMethodFailMsg=r}),e.$on("popupChoosePayMethodPending",function(e,r){f.popupChoosePayMethodPending=r}),f.$onInit=function(){var e=a.getParamFromLocation("result");"success"===e?!f.orderInfo.header||"being_paid"!==f.orderInfo.header.status&&"being_paid_for_exchange"!==f.orderInfo.header.status?f.loading=!1:o.waitPayment(f.orderInfo.header.regnum,f.orderInfo.header.lastName).then(function(){r.location="./order?pnr="+f.orderInfo.header.regnum+"&lastName="+f.orderInfo.header.lastName+"&result=success"},function(){f.loading=!1}):(!f.orderInfo.hasFailedServices&&f.orderInfo.paymentRedirectTo&&(f.showPaymentFrame=!0),f.loading=!1),!f.orderInfo.hasFailedServices||e||!f.orderInfo.header||"being_paid"!==f.orderInfo.header.status&&"booked"!==f.orderInfo.header.status||n(function(){t.openHandler("popupRemovedServicesWarningByOrder",!1,{submitCallback:function(){f.orderInfo.paymentRedirectTo&&(f.showPaymentFrame=!0),f.ignoreFailedServices=!0},disableOutsideCloseClick:!0})}),o.getParam("ffp.enable")&&(f.orderInfo.hasBonusCard||f.orderInfo.ffpSumm)&&o.ffpBonus().then(function(e){f.ffpBonus=e.total||0})}}var a=angular.module("app");a.component("orderWithEs",{templateUrl:"components/order-with-es/order-with-es.html",controller:"orderWithEsController",controllerAs:"vm",transclude:{"extra-services":"nwExtraServicesList",payment:"div"},bindings:{orderInfo:"="}}),a.controller("orderWithEsController",["$scope","$window","$timeout","backend","utils","redirect","fancyboxTools","uniqueTabIdGenerator",o])},{}],5:[function(e,r,n){"use strict";function o(e,r,n){function o(e){e&&_.forEach(e,function(e){_.forEach(e.flights,function(e){var n=e.originport?e.originport:e.origincity,o=e.destinationport?e.destinationport:e.destinationcity,a=!1;_.forEach(u.redefineRules,function(s){_.forEach(s.routes,function(t){if(n===t.from&&o===t.to||t.from===o&&t.to===n){console.log("we redefine some rules here, check the replacWith directive"),a=!0;var i={brand:e.brand,brandAvailableProps:e.brandAvailableProps,brandUnavailableProps:e.brandUnavailableProps,brandPaidProps:e.brandPaidProps},c=r.getBrandConfig();c.filter(function(e){return e.code===i.brand})[0];_.forEach(s.brands,function(r){if(i.brand===r.brand){_.forEach(r.props,function(r){switch(r.available){case"yes":e.brandAvailableProps.push(r.name);break;case"no":e.brandUnavailableProps.push(r.name);break;case"paid":e.brandPaidProps.push(r.name)}})}})}})})})})}function a(e){u.needToRestoreBrandsInfo=!1,e&&"boolean"==typeof u.originalBrands&&(u.originalBrands=angular.copy(r.getBrandConfig()));var n=!1;s(e)&&(n=!0),n?t(e.brandsList):"boolean"!=typeof u.originalBrands&&e.brandsList&&(e.brandsList=e.brandsList.map(function(e,r){return u.originalBrands.filter(function(r){return r.code===e.code})[0]}),u.needToRestoreBrandsInfo=!0)}function s(e){var r=!1;return _.forEach(u.redefineRules,function(n){_.forEach(n.routes,function(n){_.forEach(e.segmentRows,function(e){_.forEach(e,function(e){var o=e.flightsInfo.originport?e.flightsInfo.originport:e.flightsInfo.origincity,a=e.flightsInfo.destinationport?e.flightsInfo.destinationport:e.flightsInfo.destinationcity;(o===n.from&&a===n.to||o===n.to&&a===n.from)&&(r=!0)})})})}),r}function t(e){_.forEach(u.redefineRules,function(r){_.forEach(r.brands,function(r){_.forEach(e.slice(),function(e){e.code===r.brand&&i(e,r)})})})}function i(e,r){console.log("we redefine some rules here, head to web.brandConfig.redefine"),console.log(e,r),_.forEach(e.props,function(e){r.props[e.code]&&_.extend(e,r.props[e.code])})}function c(){u.selectedVariantsInfo&&u.needToRestoreBrandsInfo&&(console.log("restoreBrandsInfo"),_.forEach(u.selectedVariantsInfo,d))}function d(e){var r=l(e.brand),n=[],o=[],a=[];_.forEach(r.props,function(e){switch(e.available){case"yes":e.shortDesc?n.push(e.shortDesc):n.push(e.name);break;case"paid":o.push(e.name);break;case"no":a.push(e.name);break;default:return}}),e.brandAvailableProps=n.slice(),e.brandPaidProps=o.slice(),e.brandUnavailableProps=a.slice()}function l(e){return u.originalBrands.filter(function(r){return r.code===e})[0]}var u=e.$parent.vm;u.originalBrands=!1,u.needToRestoreBrandsInfo=!1,r.ready.then(function(){try{var s=JSON.parse(r.getAlias("web.brandConfig.redefine"))}catch(t){console.error("redefine rules parse error",t)}u.redefineRules=s,e.$watch(angular.bind(this,function(){return u.selectedVariantsInfo}),c),e.$watch(angular.bind(this,function(){return u.searchResult}),function(e){"/search-order"!==n.path()&&a(e)}),e.$watch(angular.bind(this,function(){return u.orderInfo?u.orderInfo.flights:void 0}),function(e){o(e)})})}var a=angular.module("app");a.directive("replaceWith",function(){return{scope:!1,controllerAs:"replaceWith",bindToController:!0,scopeAs:"vm",controller:"isRouteController"}}),a.controller("isRouteController",["$scope","backend","$location",o])},{}],6:[function(e,r,n){"use strict";e("./screens/add-services/AddServicesScreenController"),e("./screens/search-order/search-order"),e("./directives/replaceWith"),e("./components/nw-meal-popup/nw-meal-popup"),e("./components/order-with-es/order-with-es"),e("./components/nw-extra-services-list/nw-extra-services-list"),e("./components/nw-meal/nw-meal"),angular.module("app").config(["$compileProvider",function(e){e.debugInfoEnabled(!0)}]),angular.module("app").run(["$rootScope","redirect","backend",function(e,r,n){e.$on("$locationChangeStart",function(e){var n=location.href.split("#")[1];n=n.split("/");var o=n[1],a=n[2],s=n[3];"add-services"===o&&a&&s&&(s=decodeURIComponent(s),r.goToSearchOrder(a,s))})}])},{"./components/nw-extra-services-list/nw-extra-services-list":1,"./components/nw-meal-popup/nw-meal-popup":2,"./components/nw-meal/nw-meal":3,"./components/order-with-es/order-with-es":4,"./directives/replaceWith":5,"./screens/add-services/AddServicesScreenController":7,"./screens/search-order/search-order":8}],7:[function(e,r,n){"use strict";angular.module("app").controller("AddServicesScreenController",["$scope","$routeParams","$window","redirect","backend","utils","fancyboxTools",function(e,r,n,o,a,s,t){function i(e){!p.agree||p.modifyServicesLoading||p.orderServicesLoading||(p.selectedPaymentForm&&p.selectedPaymentType?c(e):p.showNeedSelectPaymentFormMesage=!0)}function c(e,r,n){p.confirmLoading=!0,p.confirmError&&delete p.confirmError,a.startPaymentForExtraServices(p.selectedPaymentForm,p.selectedPaymentType,e,r,n,p.card).then(function(s){s.pnr&&s.lastName?o.goToConfirmOrder():s.eraseAeroexpressBecauseOfCurrency||s.eraseInsuranceBecauseOfCurrency?t.openHandler("popupChangeCurrencyError",!1,{eraseAeroexpressBecauseOfCurrency:s.eraseAeroexpressBecauseOfCurrency,eraseInsuranceBecauseOfCurrency:s.eraseInsuranceBecauseOfCurrency,mode:"addServices",submitCallback:i}):s.removedSvcs&&s.removedSvcs.length&&t.openHandler("popupRemovedServicesWarning",!1,{submitCallback:function(){c(e,r,n)},closeCallback:function(){a.updateOrderServices(!0)},removedSvcs:s.removedSvcs,svcsToIssue:s.svcsToIssue,noExtraServicesLeft:s.noExtraServicesLeft,disableOutsideCloseClick:!0}),p.confirmLoading=!1},function(e){"web.noBookedConfirmedExtraServices"===e.error?p.fatalError=e.error:p.confirmError=e.error,p.confirmLoading=!1})}function d(){p.showNeedSelectPaymentFormMesage=!1}function l(){return n.location.reload(),!1}function u(){a.clearSession().then(function(){o.goToSearchOrder()})}function f(){p.submitButtonHover=!p.submitButtonHover}var p=this;p.loading=!0,p.searchOrderLoading=!0,p.orderServicesLoading=!0,p.openOrder=o.goToSearchOrder,p.submitPayment=i,p.paymentFormChangeHandler=d,p.reloadPage=l,p.clearSession=u,p.swithcSubmitButtonHoverState=f,e.$on("plasticCardForPaymentChangeEvent",function(e,r){p.card=r}),a.ready.then(function(){angular.element("title").text(a.getAliasWithPrefix("web.pageTitle.","addServices")),p.loading=!1,a.clearOrderInfoListeners(),a.clearUpdateOrderServicesListeners(),a.addOrderInfoListener(function(e){p.orderInfo=e}),a.addUpdateOrderServicesListener(function(e){p.orderInfo=e[1],p.priceVariant=e[2],p.isFreePricevariant=s.isFreePricevariant(e[2]),p.isFreePricevariant&&(p.showNeedSelectPaymentFormMesage=!1),p.es=s.reformatAvailableExtraServices(e[0],p.orderInfo,p.es),p.esList=s.getAvailableExtraServicesList(e[0],p.es),p.searchOrderLoading=!1,p.orderServicesLoading=!1,a.getParam("ffp.enable")&&(p.orderInfo.hasBonusCard||p.orderInfo.ffpSumm)&&a.ffpBonus().then(function(e){p.ffpBonus=e.total||0})},function(e){p.searchOrderLoading=!1,p.orderServicesLoading=!1,p.errorMessage=e.error}),a.updateOrderServices(!0).then(function(){p.loading=!0,a.switchDefaultSelectedServices(p.esList,p.es,p.orderInfo).then(function(){p.loading=!1},function(e){p.errorMessage=e.error,p.loading=!1})}),a.addExtraServiceListener(function(e){p.modifyServicesLoading=!e,p.orderServicesLoading=!0}),a.addExtraServiceErrorListener(function(e,r){r&&"seat"===r.code||(p.modifyServicesError=e.error),p.modifyServicesLoading=!1,p.orderServicesLoading=!0})})}])},{}],8:[function(e,r,n){"use strict";function o(e,r,n,o,a,s,t){function i(e){!v.agree||v.modifyServicesLoading||v.orderServicesLoading||(v.selectedPaymentForm&&v.selectedPaymentType?c(e):v.showNeedSelectPaymentFormMesage=!0)}function c(e,r,a){v.confirmLoading=!0,v.confirmError&&delete v.confirmError,n.startPaymentForExtraServices(v.selectedPaymentForm,v.selectedPaymentType,e,r,a,v.card).then(function(s){s.pnr&&s.lastName?o.goToConfirmOrder():s.eraseAeroexpressBecauseOfCurrency||s.eraseInsuranceBecauseOfCurrency?t.openHandler("popupChangeCurrencyError",!1,{eraseAeroexpressBecauseOfCurrency:s.eraseAeroexpressBecauseOfCurrency,eraseInsuranceBecauseOfCurrency:s.eraseInsuranceBecauseOfCurrency,mode:"addServices",submitCallback:i}):s.removedSvcs&&s.removedSvcs.length&&t.openHandler("popupRemovedServicesWarning",!1,{submitCallback:function(){c(e,r,a)},closeCallback:function(){n.updateOrderServices(!0)},removedSvcs:s.removedSvcs,svcsToIssue:s.svcsToIssue,noExtraServicesLeft:s.noExtraServicesLeft,disableOutsideCloseClick:!0}),v.confirmLoading=!1},function(e){"web.noBookedConfirmedExtraServices"===e.error?v.fatalError=e.error:v.confirmError=e.error,v.confirmLoading=!1})}function d(){n.clearSession(),n.clearOrderInfo(),v.orderInfo=!1,v.showSearchForm=!0,v.partiallyAddedPassengers=[]}function l(){v.submitTouched=!0,n.getParam("site.useSearchOrderAgreeCheckbox")&&!v.searchOrderAgree||!v.searchOrderForm.$valid||(v.searchLoading=!0,v.errorMessage=!1,n.searchOrderByParams(v.searchParams,!!v.partiallyAddedPassengers.length).then(function(e){v.searchParams.flight&&v.searchParams.date?v.searchParams={flight:v.searchParams.flight,date:v.searchParams.date}:e.needToSpecifyDocument||(v.searchParams={}),v.needToSpecifyDocument=e.needToSpecifyDocument,v.showSearchForm=!1,v.submitTouched=!1,u(),e.orderCompletelyInitialized?(v.partiallyAddedPassengers=[],f()):(e.partiallyAddedPassengers&&(v.partiallyAddedPassengers=e.partiallyAddedPassengers),v.needToSpecifyDocument&&(v.showSearchForm=!0)),v.searchLoading=!1},p))}function u(){n.addUpdateOrderServicesListener(function(e){v.orderInfo=e[1],v.priceVariant=e[2],v.isFreePricevariant=s.isFreePricevariant(e[2]),v.isFreePricevariant&&(v.showNeedSelectPaymentFormMesage=!1),v.es=s.reformatAvailableExtraServices(e[0],v.orderInfo,v.es),v.esList=s.getAvailableExtraServicesList(e[0],v.es),v.searchOrderLoading=!1,v.orderServicesLoading=!1,n.getParam("ffp.enable")&&(v.orderInfo.hasBonusCard||v.orderInfo.ffpSumm)&&n.ffpBonus().then(function(e){v.ffpBonus=e.total||0})},function(e){v.searchOrderLoading=!1,v.orderServicesLoading=!1,v.errorMessage=e.error}),n.updateOrderServices(!0).then(function(){v.loading=!0,n.switchDefaultSelectedServices(v.esList,v.es,v.orderInfo).then(function(){v.loading=!1},function(e){v.errorMessage=e.error,v.loading=!1})}),n.addExtraServiceListener(function(e){v.modifyServicesLoading=!e,v.orderServicesLoading=!0}),n.addExtraServiceErrorListener(function(e,r){r&&"seat"===r.code||(v.modifyServicesError=e.error),v.modifyServicesLoading=!1,v.orderServicesLoading=!0})}function f(e){n.updateOrderInfo().then(function(r){r.passengers&&(v.orderInfo=r,v.showSearchForm=!1,"function"==typeof e&&e()),v.loading=!1},p)}function p(e){v.loading=!1,v.searchLoading=!1,"web.messages.emptyOrder"!==e.error&&(v.errorMessage=e.error)}function m(){n.finishSeparatePassengersSearch().then(f,p)}function g(){v.showSearchForm=!0}function h(){v.submitButtonHover=!v.submitButtonHover}var v=this;v.loading=!0,v.searchOrderLoading=!0,v.orderServicesLoading=!0,v.showSearchForm=!0,v.searchParams={},v.partiallyAddedPassengers=[],v.submitPayment=i,v.submitSearch=l,v.confirmHandler=m,v.clear=d,v.addPassenger=g,v.swithcSubmitButtonHoverState=h,n.ready.then(function(){angular.element("title").text(n.getAliasWithPrefix("web.pageTitle.","searchOrder")),v.passengerLastNameRegexp=n.applicationConstants.passengerLastNameRegexp,v.pnrOrTicketRegexp=n.applicationConstants.pnrOrTicketRegexp,v.ticketRegexp=n.applicationConstants.ticketRegexp,n.clearOrderInfoListeners(),n.clearUpdateOrderServicesListeners(),r.pnrOrTicketNumber&&r.lastName&&"LAST_NAME_PNR_TICKET"===n.getParam("site.searchOrdersBy")?(v.searchParams.pnrOrTicketNumber=r.pnrOrTicketNumber,v.searchParams.lastName=r.lastName,v.loading=!1,console.log("submit search"),a(l)):(console.log("else block"),f(),u()),n.addOrderInfoListener(function(e){console.log("add order info listener"),v.orderInfo=e})})}angular.module("app").controller("SearchOrderScreenController",["$scope","$routeParams","backend","redirect","$timeout","utils","fancyboxTools",o])},{}]},{},[6]);
//# sourceMappingURL=controllers-nordwind.js.map
