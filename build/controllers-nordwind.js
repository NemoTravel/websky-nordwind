!function(){function e(r,n,o){function a(i,s){if(!n[i]){if(!r[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(t)return t(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var f=n[i]={exports:{}};r[i][0].call(f.exports,function(e){var n=r[i][1][e];return a(n||e)},f,f.exports,e,r,n,o)}return n[i].exports}for(var t="function"==typeof require&&require,i=0;i<o.length;i++)a(o[i]);return a}return e}()({1:[function(e,r,n){"use strict";function o(e,r,n,o,a,t,i,s){function c(e){l.loading=!0,o.retryRegister(e).then(function(e){e.pnr&&e.lastName?r.location="./order?pnr="+e.pnr+"&lastName="+e.lastName:(e.eraseAeroexpressBecauseOfCurrency||e.eraseInsuranceBecauseOfCurrency)&&i.openHandler("popupChangeCurrencyError",!1,{eraseAeroexpressBecauseOfCurrency:e.eraseAeroexpressBecauseOfCurrency,eraseInsuranceBecauseOfCurrency:e.eraseInsuranceBecauseOfCurrency,mode:"retryRegister",submitCallback:c}),l.loading=!1},function(e){l.loading=!1,l.errorMessage=e.error})}function d(){l.orderInfo.header&&l.orderInfo.header.regnum&&l.orderInfo.header.lastName&&(l.loading=!0,o.bindOrder(l.orderInfo.header.regnum,l.orderInfo.header.lastName).then(function(){l.loading=!1,l.orderInfo.bindAlowed=!1,l.showBindOrderSuccessMessage=!0,n(function(){l.showBindOrderSuccessMessage=!1},1e4)},function(){l.loading=!1,l.showBindOrderFailMessage=!0,n(function(){l.showBindOrderFailMessage=!1},1e4)}))}function f(){o.clearSession().then(function(){t.goToSearchOrder()})}function u(){o.clearLastSearchParams().then(function(){r.location=o.getAlias("web.site.firstStepUrl")})}var l=this;l.loading=!0,l.errorMessage=!1,l.choosePayMethodFailMsg=!1,l.tabId=s(),l.openExchange=t.goToExchange,l.openRefund=t.goToRefund,l.openAddServices=t.goToAddServices,l.suffixCount=a.suffixCount,l.retryPayment=c,l.bindOrder=d,l.clearSession=f,l.newBooking=u,e.$on("popupChoosePayMethodChoosePayMethodFailMsg",function(e,r){l.choosePayMethodFailMsg=r}),e.$on("popupChoosePayMethodPending",function(e,r){l.popupChoosePayMethodPending=r}),l.$onInit=function(){var e=a.getParamFromLocation("result");"success"===e?!l.orderInfo.header||"being_paid"!==l.orderInfo.header.status&&"being_paid_for_exchange"!==l.orderInfo.header.status?l.loading=!1:o.waitPayment(l.orderInfo.header.regnum,l.orderInfo.header.lastName).then(function(){r.location="./order?pnr="+l.orderInfo.header.regnum+"&lastName="+l.orderInfo.header.lastName+"&result=success"},function(){l.loading=!1}):(!l.orderInfo.hasFailedServices&&l.orderInfo.paymentRedirectTo&&(l.showPaymentFrame=!0),l.loading=!1),!l.orderInfo.hasFailedServices||e||!l.orderInfo.header||"being_paid"!==l.orderInfo.header.status&&"booked"!==l.orderInfo.header.status||n(function(){i.openHandler("popupRemovedServicesWarningByOrder",!1,{submitCallback:function(){l.orderInfo.paymentRedirectTo&&(l.showPaymentFrame=!0),l.ignoreFailedServices=!0},disableOutsideCloseClick:!0})}),o.getParam("ffp.enable")&&(l.orderInfo.hasBonusCard||l.orderInfo.ffpSumm)&&o.ffpBonus().then(function(e){l.ffpBonus=e.total||0})}}var a=angular.module("app");a.component("orderWithEs",{templateUrl:"components/order-with-es/order-with-es.html",controller:"orderWithEsController",controllerAs:"vm",transclude:{"extra-services":"extraServicesList",payment:"div"},bindings:{orderInfo:"="}}),a.controller("orderWithEsController",["$scope","$window","$timeout","backend","utils","redirect","fancyboxTools","uniqueTabIdGenerator",o])},{}],2:[function(e,r,n){"use strict";function o(e,r,n){function o(e){e&&_.forEach(e,function(e){_.forEach(e.flights,function(e){var n=e.originport?e.originport:e.origincity,o=e.destinationport?e.destinationport:e.destinationcity,a=!1;_.forEach(u.redefineRules,function(t){_.forEach(t.routes,function(i){if(n===i.from&&o===i.to||i.from===o&&i.to===n){console.log("we redefine some rules here, check the replacWith directive"),a=!0;var s={brand:e.brand,brandAvailableProps:e.brandAvailableProps,brandUnavailableProps:e.brandUnavailableProps,brandPaidProps:e.brandPaidProps},c=r.getBrandConfig();c.filter(function(e){return e.code===s.brand})[0];_.forEach(t.brands,function(r){if(s.brand===r.brand){_.forEach(r.props,function(r){switch(r.available){case"yes":e.brandAvailableProps.push(r.name);break;case"no":e.brandUnavailableProps.push(r.name);break;case"paid":e.brandPaidProps.push(r.name)}})}})}})})})})}function a(e){u.needToRestoreBrandsInfo=!1,e&&"boolean"==typeof u.originalBrands&&(u.originalBrands=angular.copy(r.getBrandConfig()));var n=!1;t(e)&&(n=!0),n?i(e.brandsList):"boolean"!=typeof u.originalBrands&&e.brandsList&&(e.brandsList=e.brandsList.map(function(e,r){return u.originalBrands.filter(function(r){return r.code===e.code})[0]}),u.needToRestoreBrandsInfo=!0)}function t(e){var r=!1;return _.forEach(u.redefineRules,function(n){_.forEach(n.routes,function(n){_.forEach(e.segmentRows,function(e){_.forEach(e,function(e){var o=e.flightsInfo.originport?e.flightsInfo.originport:e.flightsInfo.origincity,a=e.flightsInfo.destinationport?e.flightsInfo.destinationport:e.flightsInfo.destinationcity;(o===n.from&&a===n.to||o===n.to&&a===n.from)&&(r=!0)})})})}),r}function i(e){_.forEach(u.redefineRules,function(r){_.forEach(r.brands,function(r){_.forEach(e.slice(),function(e){e.code===r.brand&&s(e,r)})})})}function s(e,r){console.log("we redefine some rules here, head to web.brandConfig.redefine"),console.log(e,r),_.forEach(e.props,function(e){r.props[e.code]&&_.extend(e,r.props[e.code])})}function c(){u.selectedVariantsInfo&&u.needToRestoreBrandsInfo&&(console.log("restoreBrandsInfo"),_.forEach(u.selectedVariantsInfo,d))}function d(e){var r=f(e.brand),n=[],o=[],a=[];_.forEach(r.props,function(e){switch(e.available){case"yes":e.shortDesc?n.push(e.shortDesc):n.push(e.name);break;case"paid":o.push(e.name);break;case"no":a.push(e.name);break;default:return}}),e.brandAvailableProps=n.slice(),e.brandPaidProps=o.slice(),e.brandUnavailableProps=a.slice()}function f(e){return u.originalBrands.filter(function(r){return r.code===e})[0]}var u=e.$parent.vm;u.originalBrands=!1,u.needToRestoreBrandsInfo=!1,r.ready.then(function(){try{var t=JSON.parse(r.getAlias("web.brandConfig.redefine"))}catch(i){console.error("redefine rules parse error",i)}u.redefineRules=t,e.$watch(angular.bind(this,function(){return u.selectedVariantsInfo}),c),e.$watch(angular.bind(this,function(){return u.searchResult}),function(e){"/search-order"!==n.path()&&a(e)}),e.$watch(angular.bind(this,function(){return u.orderInfo?u.orderInfo.flights:void 0}),function(e){o(e)})})}var a=angular.module("app");a.directive("replaceWith",function(){return{scope:!1,controllerAs:"replaceWith",bindToController:!0,scopeAs:"vm",controller:"isRouteController"}}),a.controller("isRouteController",["$scope","backend","$location",o])},{}],3:[function(e,r,n){"use strict";e("./screens/add-services/AddServicesScreenController"),e("./screens/search-order/search-order"),e("./directives/replaceWith"),e("./components/order-with-es/order-with-es"),angular.module("app").config(["$compileProvider",function(e){e.debugInfoEnabled(!0)}]),angular.module("app").run(["$rootScope","redirect","backend",function(e,r,n){e.$on("$locationChangeStart",function(e){var n=location.href.split("#")[1];n=n.split("/");var o=n[1],a=n[2],t=n[3];"add-services"===o&&a&&t&&(t=decodeURIComponent(t),r.goToSearchOrder(a,t))})}])},{"./components/order-with-es/order-with-es":1,"./directives/replaceWith":2,"./screens/add-services/AddServicesScreenController":4,"./screens/search-order/search-order":5}],4:[function(e,r,n){"use strict";angular.module("app").controller("AddServicesScreenController",["$scope","$routeParams","$window","redirect","backend","utils","fancyboxTools",function(e,r,n,o,a,t,i){function s(e){!h.agree||h.modifyServicesLoading||h.orderServicesLoading||(h.selectedPaymentForm&&h.selectedPaymentType?c(e):h.showNeedSelectPaymentFormMesage=!0)}function c(e,r,n){h.confirmLoading=!0,h.confirmError&&delete h.confirmError,a.startPaymentForExtraServices(h.selectedPaymentForm,h.selectedPaymentType,e,r,n,h.card).then(function(t){t.pnr&&t.lastName?o.goToConfirmOrder():t.eraseAeroexpressBecauseOfCurrency||t.eraseInsuranceBecauseOfCurrency?i.openHandler("popupChangeCurrencyError",!1,{eraseAeroexpressBecauseOfCurrency:t.eraseAeroexpressBecauseOfCurrency,eraseInsuranceBecauseOfCurrency:t.eraseInsuranceBecauseOfCurrency,mode:"addServices",submitCallback:s}):t.removedSvcs&&t.removedSvcs.length&&i.openHandler("popupRemovedServicesWarning",!1,{submitCallback:function(){c(e,r,n)},closeCallback:function(){a.updateOrderServices(!0)},removedSvcs:t.removedSvcs,svcsToIssue:t.svcsToIssue,noExtraServicesLeft:t.noExtraServicesLeft,disableOutsideCloseClick:!0}),h.confirmLoading=!1},function(e){"web.noBookedConfirmedExtraServices"===e.error?h.fatalError=e.error:h.confirmError=e.error,h.confirmLoading=!1})}function d(){h.showNeedSelectPaymentFormMesage=!1}function f(){return n.location.reload(),!1}function u(){a.clearSession().then(function(){o.goToSearchOrder()})}function l(){h.submitButtonHover=!h.submitButtonHover}var h=this;h.loading=!0,h.searchOrderLoading=!0,h.orderServicesLoading=!0,h.openOrder=o.goToSearchOrder,h.submitPayment=s,h.paymentFormChangeHandler=d,h.reloadPage=f,h.clearSession=u,h.swithcSubmitButtonHoverState=l,e.$on("plasticCardForPaymentChangeEvent",function(e,r){h.card=r}),a.ready.then(function(){angular.element("title").text(a.getAliasWithPrefix("web.pageTitle.","addServices")),h.loading=!1,a.clearOrderInfoListeners(),a.clearUpdateOrderServicesListeners(),a.addOrderInfoListener(function(e){h.orderInfo=e}),a.addUpdateOrderServicesListener(function(e){h.orderInfo=e[1],h.priceVariant=e[2],h.isFreePricevariant=t.isFreePricevariant(e[2]),h.isFreePricevariant&&(h.showNeedSelectPaymentFormMesage=!1),h.es=t.reformatAvailableExtraServices(e[0],h.orderInfo,h.es),h.esList=t.getAvailableExtraServicesList(e[0],h.es),h.searchOrderLoading=!1,h.orderServicesLoading=!1,a.getParam("ffp.enable")&&(h.orderInfo.hasBonusCard||h.orderInfo.ffpSumm)&&a.ffpBonus().then(function(e){h.ffpBonus=e.total||0})},function(e){h.searchOrderLoading=!1,h.orderServicesLoading=!1,h.errorMessage=e.error}),a.updateOrderServices(!0).then(function(){h.loading=!0,a.switchDefaultSelectedServices(h.esList,h.es,h.orderInfo).then(function(){h.loading=!1},function(e){h.errorMessage=e.error,h.loading=!1})}),a.addExtraServiceListener(function(e){h.modifyServicesLoading=!e,h.orderServicesLoading=!0}),a.addExtraServiceErrorListener(function(e,r){r&&"seat"===r.code||(h.modifyServicesError=e.error),h.modifyServicesLoading=!1,h.orderServicesLoading=!0})})}])},{}],5:[function(e,r,n){"use strict";function o(e,r,n,o,a,t){function i(e){!g.agree||g.modifyServicesLoading||g.orderServicesLoading||g.selectedPaymentForm&&g.selectedPaymentType&&s(e)}function s(e,r,o){g.confirmLoading=!0,g.confirmError&&delete g.confirmError,n.startPaymentForExtraServices(g.selectedPaymentForm,g.selectedPaymentType,e,r,o,g.card).then(function(n){console.log(g.selectedPaymentForm,g.selectedPaymentType,e,r,o,g.card)})}function c(){n.clearSession(),n.clearOrderInfo(),g.orderInfo=!1,g.showSearchForm=!0,g.partiallyAddedPassengers=[]}function d(){g.submitTouched=!0,n.getParam("site.useSearchOrderAgreeCheckbox")&&!g.searchOrderAgree||!g.searchOrderForm.$valid||(g.searchLoading=!0,g.errorMessage=!1,n.searchOrderByParams(g.searchParams,!!g.partiallyAddedPassengers.length).then(function(e){g.searchParams.flight&&g.searchParams.date?g.searchParams={flight:g.searchParams.flight,date:g.searchParams.date}:e.needToSpecifyDocument||(g.searchParams={}),g.needToSpecifyDocument=e.needToSpecifyDocument,g.showSearchForm=!1,g.submitTouched=!1,e.orderCompletelyInitialized?(g.partiallyAddedPassengers=[],f()):(e.partiallyAddedPassengers&&(g.partiallyAddedPassengers=e.partiallyAddedPassengers),g.needToSpecifyDocument&&(g.showSearchForm=!0)),g.searchLoading=!1},u))}function f(e){n.updateOrderInfo().then(function(r){r.passengers&&(g.orderInfo=r,g.showSearchForm=!1,"function"==typeof e&&e()),g.loading=!1},u)}function u(e){g.loading=!1,g.searchLoading=!1,"web.messages.emptyOrder"!==e.error&&(g.errorMessage=e.error)}function l(){n.finishSeparatePassengersSearch().then(f,u)}function h(){g.showSearchForm=!0}function p(){g.submitButtonHover=!g.submitButtonHover}var g=this;g.loading=!0,g.searchOrderLoading=!0,g.orderServicesLoading=!0,g.showSearchForm=!0,g.searchParams={},g.partiallyAddedPassengers=[],g.submitPayment=i,g.submitSearch=d,g.confirmHandler=l,g.clear=c,g.addPassenger=h,g.swithcSubmitButtonHoverState=p,n.ready.then(function(){angular.element("title").text(n.getAliasWithPrefix("web.pageTitle.","searchOrder")),g.passengerLastNameRegexp=n.applicationConstants.passengerLastNameRegexp,g.pnrOrTicketRegexp=n.applicationConstants.pnrOrTicketRegexp,g.ticketRegexp=n.applicationConstants.ticketRegexp,r.pnrOrTicketNumber&&r.lastName&&"LAST_NAME_PNR_TICKET"===n.getParam("site.searchOrdersBy")?(g.searchParams.pnrOrTicketNumber=r.pnrOrTicketNumber,g.searchParams.lastName=r.lastName,g.loading=!1,a(d)):f(),n.clearOrderInfoListeners(),n.clearUpdateOrderServicesListeners(),n.addOrderInfoListener(function(e){g.orderInfo=e}),n.addUpdateOrderServicesListener(function(e){g.orderInfo=e[1],g.priceVariant=e[2],g.isFreePricevariant=t.isFreePricevariant(e[2]),g.isFreePricevariant&&(g.showNeedSelectPaymentFormMesage=!1),g.es=t.reformatAvailableExtraServices(e[0],g.orderInfo,g.es),g.esList=t.getAvailableExtraServicesList(e[0],g.es),g.searchOrderLoading=!1,g.orderServicesLoading=!1,n.getParam("ffp.enable")&&(g.orderInfo.hasBonusCard||g.orderInfo.ffpSumm)&&n.ffpBonus().then(function(e){g.ffpBonus=e.total||0})},function(e){g.searchOrderLoading=!1,g.orderServicesLoading=!1,g.errorMessage=e.error}),n.updateOrderServices(!0).then(function(){g.loading=!0,n.switchDefaultSelectedServices(g.esList,g.es,g.orderInfo).then(function(){g.loading=!1},function(e){g.errorMessage=e.error,g.loading=!1})}),n.addExtraServiceListener(function(e){g.modifyServicesLoading=!e,g.orderServicesLoading=!0}),n.addExtraServiceErrorListener(function(e,r){r&&"seat"===r.code||(g.modifyServicesError=e.error),g.modifyServicesLoading=!1,g.orderServicesLoading=!0})})}angular.module("app").controller("SearchOrderScreenController",["$scope","$routeParams","backend","redirect","$timeout","utils",o])},{}]},{},[3]);
//# sourceMappingURL=controllers-nordwind.js.map
