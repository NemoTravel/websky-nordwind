{"version":3,"sources":["controllers-nordwind.js"],"names":["r","e","n","t","o","i","f","c","require","u","a","Error","code","p","exports","call","length","1","module","./screens/add-services/AddServicesScreenController","./screens/search-order/search-order","2","angular","controller","$scope","$routeParams","$window","redirect","backend","utils","fancyboxTools","orderReadyHandler","addOrderInfoListener","orderInfo","vm","addUpdateOrderServicesListener","resp","priceVariant","isFreePricevariant","showNeedSelectPaymentFormMesage","es","reformatAvailableExtraServices","esList","getAvailableExtraServicesList","searchOrderLoading","orderServicesLoading","getParam","hasBonusCard","ffpSumm","ffpBonus","then","total","errorMessage","error","showBackButton","updateOrderServices","loading","switchDefaultSelectedServices","addExtraServiceListener","state","modifyServicesLoading","addExtraServiceErrorListener","req","modifyServicesError","submitPayment","removeInsuranceAeroexpress","agree","selectedPaymentForm","selectedPaymentType","openHandler","phoneRequiredToo","submitCallback","email","phone","submitPaymentConfirm","confirmLoading","confirmError","startPaymentForExtraServices","card","pnr","lastName","goToConfirmOrder","eraseAeroexpressBecauseOfCurrency","eraseInsuranceBecauseOfCurrency","mode","removedSvcs","closeCallback","svcsToIssue","noExtraServicesLeft","disableOutsideCloseClick","fatalError","paymentFormChangeHandler","reloadPage","location","reload","openOrder","pnrOrTicketNumber","goToViewSeparateOrder","goToSearchOrder","clearSession","this","$on","event","data","ready","element","text","getAliasWithPrefix","clearOrderInfoListeners","clearUpdateOrderServicesListeners","getOrderInfo","searchOrder","3","SearchOrderScreenController","submitSearch","submitTouched","searchOrderAgree","searchOrderForm","$valid","goToAddServices","searchParams","clear","goToSearchSeparateOrder","passengerLastNameRegexp","applicationConstants","pnrOrTicketRegexp","clearOrderInfo","orderLoaded"],"mappings":"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","file":"controllers-nordwind.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){\n\"use strict\";\nrequire('./screens/add-services/AddServicesScreenController');\nrequire('./screens/search-order/search-order');\n\n},{\"./screens/add-services/AddServicesScreenController\":2,\"./screens/search-order/search-order\":3}],2:[function(require,module,exports){\n\"use strict\";\n'use strict';\n\nangular.module('app').controller('AddServicesScreenController', ['$scope', '$routeParams', '$window', 'redirect', 'backend', 'utils', 'fancyboxTools', function ($scope, $routeParams, $window, redirect, backend, utils, fancyboxTools) {\n    var vm = this;\n\n    vm.loading = true;\n    vm.searchOrderLoading = true;\n    vm.orderServicesLoading = true;\n\n    vm.openOrder = openOrder;\n    vm.submitPayment = submitPayment;\n    vm.paymentFormChangeHandler = paymentFormChangeHandler;\n    vm.reloadPage = reloadPage;\n    vm.clearSession = clearSession;\n\n    $scope.$on('plasticCardForPaymentChangeEvent', function (event, data) {\n        vm.card = data;\n    });\n\n    backend.ready.then(function () {\n        angular.element('title').text(backend.getAliasWithPrefix('web.pageTitle.', 'addServices'));\n\n        vm.pnrOrTicketNumber = $routeParams.pnrOrTicketNumber;\n        vm.lastName = $routeParams.lastName;\n\n        vm.loading = false;\n\n        backend.clearOrderInfoListeners();\n        backend.clearUpdateOrderServicesListeners();\n\n        vm.orderInfo = backend.getOrderInfo();\n\n        if (vm.orderInfo) {\n            orderReadyHandler();\n        } else {\n            backend.searchOrder(vm.pnrOrTicketNumber, vm.lastName, true).then(orderReadyHandler, function (resp) {\n                vm.searchOrderLoading = false;\n                vm.orderServicesLoading = false;\n                vm.errorMessage = resp.error;\n            });\n        }\n\n    });\n\n    function orderReadyHandler() {\n        backend.addOrderInfoListener(function (orderInfo) {\n            vm.orderInfo = orderInfo;\n        });\n\n        backend.addUpdateOrderServicesListener(function (resp) {\n            vm.orderInfo = resp[1];\n            vm.priceVariant = resp[2];\n            vm.isFreePricevariant = utils.isFreePricevariant(resp[2]);\n\n            if (vm.isFreePricevariant) {\n                vm.showNeedSelectPaymentFormMesage = false;\n            }\n\n            vm.es = utils.reformatAvailableExtraServices(resp[0], vm.orderInfo, vm.es);\n            vm.esList = utils.getAvailableExtraServicesList(resp[0], vm.es);\n\n            vm.searchOrderLoading = false;\n            vm.orderServicesLoading = false;\n\n            if (backend.getParam('ffp.enable') && (vm.orderInfo.hasBonusCard || vm.orderInfo.ffpSumm)) {\n                backend.ffpBonus().then(function (resp) {\n                    vm.ffpBonus = resp.total || 0;\n                });\n            }\n        }, function (resp) {\n            vm.searchOrderLoading = false;\n            vm.orderServicesLoading = false;\n            vm.errorMessage = resp.error;\n\n            if (vm.errorMessage === 'web.extraServices.submitError') {\n                vm.showBackButton = true;\n            }\n        });\n\n\n        backend.updateOrderServices(true).then(function () {\n            vm.loading = true;\n\n            backend.switchDefaultSelectedServices(vm.esList, vm.es, vm.orderInfo).then(function () {\n                vm.loading = false;\n            });\n        });\n\n        backend.addExtraServiceListener(function (state) {\n            vm.modifyServicesLoading = !state;\n            vm.orderServicesLoading = true;\n        });\n\n        backend.addExtraServiceErrorListener(function (resp, req) {\n            if (!req || req.code !== 'seat') {\n                vm.modifyServicesError = resp.error;\n            }\n\n            vm.modifyServicesLoading = false;\n            vm.orderServicesLoading = true;\n        });\n    }\n\n    function submitPayment(removeInsuranceAeroexpress) {\n        if (vm.agree && !vm.modifyServicesLoading && !vm.orderServicesLoading) {\n            if (vm.selectedPaymentForm && vm.selectedPaymentType) {\n                if (backend.getParam('site.rossiyaAirlineMode')) {\n                    fancyboxTools.openHandler('popupOrderEmailRequired', false, {\n                        phoneRequiredToo: true,\n                        submitCallback: function submitCallback(email, phone) {\n                            submitPaymentConfirm(removeInsuranceAeroexpress, email, phone);\n                        }\n                    });\n                } else {\n                    submitPaymentConfirm(removeInsuranceAeroexpress);\n                }\n            } else {\n                vm.showNeedSelectPaymentFormMesage = true;\n            }\n        }\n    }\n\n    function submitPaymentConfirm(removeInsuranceAeroexpress, email, phone) {\n        vm.confirmLoading = true;\n\n        if (vm.confirmError) {\n            delete vm.confirmError;\n        }\n\n        backend.startPaymentForExtraServices(vm.selectedPaymentForm, vm.selectedPaymentType, removeInsuranceAeroexpress, email, phone, vm.card).then(function (resp) {\n            if (resp.pnr && resp.lastName) {\n                redirect.goToConfirmOrder(resp.pnr, resp.lastName);\n            } else if (resp.eraseAeroexpressBecauseOfCurrency || resp.eraseInsuranceBecauseOfCurrency) {\n                fancyboxTools.openHandler('popupChangeCurrencyError', false, {\n                    eraseAeroexpressBecauseOfCurrency: resp.eraseAeroexpressBecauseOfCurrency,\n                    eraseInsuranceBecauseOfCurrency: resp.eraseInsuranceBecauseOfCurrency,\n                    mode: 'addServices',\n                    submitCallback: submitPayment\n                });\n            } else if (resp.removedSvcs && resp.removedSvcs.length) {\n                fancyboxTools.openHandler('popupRemovedServicesWarning', false, {\n                    submitCallback: function submitCallback() {\n                        submitPaymentConfirm(removeInsuranceAeroexpress, email, phone);\n                    },\n                    closeCallback: function closeCallback() {\n                        backend.updateOrderServices(true);\n                    },\n\n                    removedSvcs: resp.removedSvcs,\n                    svcsToIssue: resp.svcsToIssue,\n                    noExtraServicesLeft: resp.noExtraServicesLeft,\n                    disableOutsideCloseClick: true\n                });\n            }\n\n            vm.confirmLoading = false;\n        }, function (resp) {\n            if (resp.error === 'web.noBookedConfirmedExtraServices') {\n                vm.fatalError = resp.error;\n            } else {\n                vm.confirmError = resp.error;\n            }\n\n            vm.confirmLoading = false;\n        });\n    }\n\n    function paymentFormChangeHandler() {\n        vm.showNeedSelectPaymentFormMesage = false;\n    }\n\n    function reloadPage() {\n        $window.location.reload();\n        return false;\n    }\n\n    function openOrder(pnrOrTicketNumber, lastName) {\n        if (backend.getParam('site.separatePassengersSearchOrder')) {\n            redirect.goToViewSeparateOrder(pnrOrTicketNumber, lastName);\n        } else {\n            redirect.goToSearchOrder(pnrOrTicketNumber, lastName);\n        }\n    }\n\n    function clearSession() {\n        backend.clearSession().then(function () {\n            redirect.goToSearchOrder();\n        });\n    }\n}]);\n\n},{}],3:[function(require,module,exports){\n\"use strict\";\nangular.module('app').controller(\n    'SearchOrderScreenController',\n    ['$routeParams', 'backend', 'redirect', SearchOrderScreenController]\n);\n\nfunction SearchOrderScreenController($routeParams, backend, redirect) {\n\n    var vm = this;\n    vm.loading = true;\n    vm.searchParams = {};\n    vm.submitSearch = submitSearch;\n    vm.clear = clear;\n\n    backend.ready.then(function () {\n\n        if (backend.getParam('site.rossiyaAirlineMode')) {\n            redirect.goToSearchSeparateOrder();\n            return;\n        }\n\n        angular.element('title').text(backend.getAliasWithPrefix('web.pageTitle.', 'searchOrder'));\n\n        vm.passengerLastNameRegexp = backend.applicationConstants.passengerLastNameRegexp;\n        vm.pnrOrTicketRegexp = backend.applicationConstants.pnrOrTicketRegexp;\n\n        backend.clearOrderInfo();\n        backend.addOrderInfoListener(function () {\n            vm.orderLoaded = true;\n        });\n\n        if ($routeParams.pnrOrTicketNumber && $routeParams.lastName) {\n\n            vm.searchParams.pnrOrTicketNumber = $routeParams.pnrOrTicketNumber;\n            vm.searchParams.lastName = $routeParams.lastName;\n\n            vm.pnrOrTicketNumber = $routeParams.pnrOrTicketNumber;\n            vm.lastName = $routeParams.lastName;\n\n            vm.submitTouched = true;\n\n        }\n\n        vm.loading = false;\n\n    });\n\n    function submitSearch() {\n        vm.submitTouched = true;\n        if (\n            (!backend.getParam('site.useSearchOrderAgreeCheckbox') || vm.searchOrderAgree) &&\n            vm.searchOrderForm.$valid\n        ) {\n            redirect.goToAddServices(vm.searchParams.pnrOrTicketNumber, vm.searchParams.lastName);\n        }\n    }\n\n    function clear() {\n        vm.pnrOrTicketNumber = false;\n        vm.lastName = false;\n    }\n\n}\n\n},{}]},{},[1]);\n"]}