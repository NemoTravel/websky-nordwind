{"version":3,"sources":["controllers-nordwind.js"],"names":["r","e","n","t","o","i","f","c","require","u","a","Error","code","p","exports","call","length","1","module","nordwindEsController","backend","vm","this","link","ready","then","getExtraServices","extraServices","extraServicesList","slice","console","log","angular","component","templateUrl","bindings","orderInfo","controller","controllerAs","2","./components/nordwind-es/nordwind-es","./screens/add-services/AddServicesScreenController","./screens/search-order/search-order","3","$scope","$routeParams","$window","redirect","utils","fancyboxTools","orderReadyHandler","addOrderInfoListener","addUpdateOrderServicesListener","resp","priceVariant","isFreePricevariant","showNeedSelectPaymentFormMesage","es","reformatAvailableExtraServices","esList","getAvailableExtraServicesList","searchOrderLoading","orderServicesLoading","getParam","hasBonusCard","ffpSumm","ffpBonus","total","errorMessage","error","showBackButton","updateOrderServices","loading","switchDefaultSelectedServices","addExtraServiceListener","state","modifyServicesLoading","addExtraServiceErrorListener","req","modifyServicesError","submitPayment","removeInsuranceAeroexpress","agree","selectedPaymentForm","selectedPaymentType","openHandler","phoneRequiredToo","submitCallback","email","phone","submitPaymentConfirm","confirmLoading","confirmError","startPaymentForExtraServices","card","pnr","lastName","goToConfirmOrder","eraseAeroexpressBecauseOfCurrency","eraseInsuranceBecauseOfCurrency","mode","removedSvcs","closeCallback","svcsToIssue","noExtraServicesLeft","disableOutsideCloseClick","fatalError","paymentFormChangeHandler","reloadPage","location","reload","openOrder","pnrOrTicketNumber","goToViewSeparateOrder","goToSearchOrder","clearSession","$on","event","data","element","text","getAliasWithPrefix","clearOrderInfoListeners","clearUpdateOrderServicesListeners","getOrderInfo","searchOrder","4","SearchOrderScreenController","submitSearch","submitTouched","searchOrderAgree","searchOrderForm","$valid","goToAddServices","searchParams","clear","goToSearchSeparateOrder","passengerLastNameRegexp","applicationConstants","pnrOrTicketRegexp","clearOrderInfo","orderLoaded"],"mappings":"CAAA,WAAY,QAASA,GAAEC,EAAEC,EAAEC,GAAG,QAASC,GAAEC,EAAEC,GAAG,IAAIJ,EAAEG,GAAG,CAAC,IAAIJ,EAAEI,GAAG,CAAC,GAAIE,GAAE,kBAAmBC,UAASA,OAAQ,KAAIF,GAAGC,EAAE,MAAOA,GAAEF,GAAE,EAAI,IAAGI,EAAE,MAAOA,GAAEJ,GAAE,EAAI,IAAIK,GAAE,GAAIC,OAAM,uBAAuBN,EAAE,IAAK,MAAMK,GAAEE,KAAK,mBAAmBF,EAAE,GAAIG,GAAEX,EAAEG,IAAIS,WAAYb,GAAEI,GAAG,GAAGU,KAAKF,EAAEC,QAAQ,SAASd,GAAG,GAAIE,GAAED,EAAEI,GAAG,GAAGL,EAAG,OAAOI,GAAEF,GAAGF,IAAIa,EAAEA,EAAEC,QAAQd,EAAEC,EAAEC,EAAEC,GAAG,MAAOD,GAAEG,GAAGS,QAAQ,IAAI,GAAIL,GAAE,kBAAmBD,UAASA,QAAQH,EAAE,EAAEA,EAAEF,EAAEa,OAAOX,IAAID,EAAED,EAAEE,GAAI,OAAOD,GAAE,MAAOJ,OAAOiB,GAAG,SAAST,EAAQU,EAAOJ,GACxe,YAWA,SAASK,GAAqBC,GAC1B,GAAIC,GAAKC,IACTD,GAAGE,KAAO,OAEVH,EAAQI,MAAMC,KAAK,WAEfL,EAAQM,mBAAmBD,KAAK,SAASE,GACrCN,EAAGO,kBAAoBD,EAAcE,QACrCC,QAAQC,IAAIV,EAAGO,uBAlB3BI,QAAQd,OAAO,OAAOe,UAAU,cAC5BC,YAAa,0CACbC,UACIC,UAAW,KAEfC,YAAa,UAAWlB,GACxBmB,aAAc,YAmBZC,GAAG,SAAS/B,EAAQU,EAAOJ,GACjC,YACAN,GAAQ,sDACRA,EAAQ,uCACRA,EAAQ,0CAELgC,uCAAuC,EAAEC,qDAAqD,EAAEC,sCAAsC,IAAIC,GAAG,SAASnC,EAAQU,EAAOJ,GACxK,YAGAkB,SAAQd,OAAO,OAAOmB,WAAW,+BAAgC,SAAU,eAAgB,UAAW,WAAY,UAAW,QAAS,gBAAiB,SAAUO,EAAQC,EAAcC,EAASC,EAAU3B,EAAS4B,EAAOC,GA0CtN,QAASC,KACL9B,EAAQ+B,qBAAqB,SAAUf,GACnCf,EAAGe,UAAYA,IAGnBhB,EAAQgC,+BAA+B,SAAUC,GAC7ChC,EAAGe,UAAYiB,EAAK,GACpBhC,EAAGiC,aAAeD,EAAK,GACvBhC,EAAGkC,mBAAqBP,EAAMO,mBAAmBF,EAAK,IAElDhC,EAAGkC,qBACHlC,EAAGmC,iCAAkC,GAGzCnC,EAAGoC,GAAKT,EAAMU,+BAA+BL,EAAK,GAAIhC,EAAGe,UAAWf,EAAGoC,IACvEpC,EAAGsC,OAASX,EAAMY,8BAA8BP,EAAK,GAAIhC,EAAGoC,IAE5DpC,EAAGwC,oBAAqB,EACxBxC,EAAGyC,sBAAuB,EAEtB1C,EAAQ2C,SAAS,gBAAkB1C,EAAGe,UAAU4B,cAAgB3C,EAAGe,UAAU6B,UAC7E7C,EAAQ8C,WAAWzC,KAAK,SAAU4B,GAC9BhC,EAAG6C,SAAWb,EAAKc,OAAS,KAGrC,SAAUd,GACThC,EAAGwC,oBAAqB,EACxBxC,EAAGyC,sBAAuB,EAC1BzC,EAAG+C,aAAef,EAAKgB,MAEC,kCAApBhD,EAAG+C,eACH/C,EAAGiD,gBAAiB,KAK5BlD,EAAQmD,qBAAoB,GAAM9C,KAAK,WACnCJ,EAAGmD,SAAU,EAEbpD,EAAQqD,8BAA8BpD,EAAGsC,OAAQtC,EAAGoC,GAAIpC,EAAGe,WAAWX,KAAK,WACvEJ,EAAGmD,SAAU,MAIrBpD,EAAQsD,wBAAwB,SAAUC,GACtCtD,EAAGuD,uBAAyBD,EAC5BtD,EAAGyC,sBAAuB,IAG9B1C,EAAQyD,6BAA6B,SAAUxB,EAAMyB,GAC5CA,GAAoB,SAAbA,EAAIlE,OACZS,EAAG0D,oBAAsB1B,EAAKgB,OAGlChD,EAAGuD,uBAAwB,EAC3BvD,EAAGyC,sBAAuB,IAIlC,QAASkB,GAAcC,IACf5D,EAAG6D,OAAU7D,EAAGuD,uBAA0BvD,EAAGyC,uBACzCzC,EAAG8D,qBAAuB9D,EAAG+D,oBACzBhE,EAAQ2C,SAAS,2BACjBd,EAAcoC,YAAY,2BAA2B,GACjDC,kBAAkB,EAClBC,eAAgB,SAAwBC,EAAOC,GAC3CC,EAAqBT,EAA4BO,EAAOC,MAIhEC,EAAqBT,GAGzB5D,EAAGmC,iCAAkC,GAKjD,QAASkC,GAAqBT,EAA4BO,EAAOC,GAC7DpE,EAAGsE,gBAAiB,EAEhBtE,EAAGuE,oBACIvE,GAAGuE,aAGdxE,EAAQyE,6BAA6BxE,EAAG8D,oBAAqB9D,EAAG+D,oBAAqBH,EAA4BO,EAAOC,EAAOpE,EAAGyE,MAAMrE,KAAK,SAAU4B,GAC/IA,EAAK0C,KAAO1C,EAAK2C,SACjBjD,EAASkD,iBAAiB5C,EAAK0C,IAAK1C,EAAK2C,UAClC3C,EAAK6C,mCAAqC7C,EAAK8C,gCACtDlD,EAAcoC,YAAY,4BAA4B,GAClDa,kCAAmC7C,EAAK6C,kCACxCC,gCAAiC9C,EAAK8C,gCACtCC,KAAM,cACNb,eAAgBP,IAEb3B,EAAKgD,aAAehD,EAAKgD,YAAYrF,QAC5CiC,EAAcoC,YAAY,+BAA+B,GACrDE,eAAgB,WACZG,EAAqBT,EAA4BO,EAAOC,IAE5Da,cAAe,WACXlF,EAAQmD,qBAAoB,IAGhC8B,YAAahD,EAAKgD,YAClBE,YAAalD,EAAKkD,YAClBC,oBAAqBnD,EAAKmD,oBAC1BC,0BAA0B,IAIlCpF,EAAGsE,gBAAiB,GACrB,SAAUtC,GACU,uCAAfA,EAAKgB,MACLhD,EAAGqF,WAAarD,EAAKgB,MAErBhD,EAAGuE,aAAevC,EAAKgB,MAG3BhD,EAAGsE,gBAAiB,IAI5B,QAASgB,KACLtF,EAAGmC,iCAAkC,EAGzC,QAASoD,KAEL,MADA9D,GAAQ+D,SAASC,UACV,EAGX,QAASC,GAAUC,EAAmBhB,GAC9B5E,EAAQ2C,SAAS,sCACjBhB,EAASkE,sBAAsBD,EAAmBhB,GAElDjD,EAASmE,gBAAgBF,EAAmBhB,GAIpD,QAASmB,KACL/F,EAAQ+F,eAAe1F,KAAK,WACxBsB,EAASmE,oBAvLjB,GAAI7F,GAAKC,IAETD,GAAGmD,SAAU,EACbnD,EAAGwC,oBAAqB,EACxBxC,EAAGyC,sBAAuB,EAE1BzC,EAAG0F,UAAYA,EACf1F,EAAG2D,cAAgBA,EACnB3D,EAAGsF,yBAA2BA,EAC9BtF,EAAGuF,WAAaA,EAChBvF,EAAG8F,aAAeA,EAElBvE,EAAOwE,IAAI,mCAAoC,SAAUC,EAAOC,GAC5DjG,EAAGyE,KAAOwB,IAGdlG,EAAQI,MAAMC,KAAK,WACfO,QAAQuF,QAAQ,SAASC,KAAKpG,EAAQqG,mBAAmB,iBAAkB,gBAE3EpG,EAAG2F,kBAAoBnE,EAAamE,kBACpC3F,EAAG2E,SAAWnD,EAAamD,SAE3B3E,EAAGmD,SAAU,EAEbpD,EAAQsG,0BACRtG,EAAQuG,oCAERtG,EAAGe,UAAYhB,EAAQwG,eAEnBvG,EAAGe,UACHc,IAEA9B,EAAQyG,YAAYxG,EAAG2F,kBAAmB3F,EAAG2E,UAAU,GAAMvE,KAAKyB,EAAmB,SAAUG,GAC3FhC,EAAGwC,oBAAqB,EACxBxC,EAAGyC,sBAAuB,EAC1BzC,EAAG+C,aAAef,EAAKgB,kBAyJjCyD,GAAG,SAAStH,EAAQU,EAAOJ,GACjC,YAMA,SAASiH,GAA4BlF,EAAczB,EAAS2B,GAyCxD,QAASiF,KACL3G,EAAG4G,eAAgB,EAEb7G,EAAQ2C,SAAS,sCAAuC1C,EAAG6G,mBAC7D7G,EAAG8G,gBAAgBC,QAEnBrF,EAASsF,gBAAgBhH,EAAGiH,aAAatB,kBAAmB3F,EAAGiH,aAAatC,UAIpF,QAASuC,KACLlH,EAAG2F,mBAAoB,EACvB3F,EAAG2E,UAAW,EAnDlB,GAAI3E,GAAKC,IACTD,GAAGmD,SAAU,EACbnD,EAAGiH,gBACHjH,EAAG2G,aAAeA,EAClB3G,EAAGkH,MAAQA,EAEXnH,EAAQI,MAAMC,KAAK,WAEf,MAAIL,GAAQ2C,SAAS,+BACjBhB,GAASyF,2BAIbxG,QAAQuF,QAAQ,SAASC,KAAKpG,EAAQqG,mBAAmB,iBAAkB,gBAE3EpG,EAAGoH,wBAA0BrH,EAAQsH,qBAAqBD,wBAC1DpH,EAAGsH,kBAAoBvH,EAAQsH,qBAAqBC,kBAEpDvH,EAAQwH,iBACRxH,EAAQ+B,qBAAqB,WACzB9B,EAAGwH,aAAc,IAGjBhG,EAAamE,mBAAqBnE,EAAamD,WAE/C3E,EAAGiH,aAAatB,kBAAoBnE,EAAamE,kBACjD3F,EAAGiH,aAAatC,SAAWnD,EAAamD,SAExC3E,EAAG2F,kBAAoBnE,EAAamE,kBACpC3F,EAAG2E,SAAWnD,EAAamD,SAE3B3E,EAAG4G,eAAgB,QAIvB5G,EAAGmD,SAAU,MA1CrBxC,QAAQd,OAAO,OAAOmB,WAClB,+BACC,eAAgB,UAAW,WAAY0F,cA6DjC","file":"controllers-nordwind.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){\n\"use strict\";\nangular.module('app').component('nordwindEs', {\n    templateUrl: 'components/nordwind-es/nordwind-es.html',\n    bindings: {\n        orderInfo: '='\n    },\n    controller: ['backend', nordwindEsController],\n    controllerAs: 'vm'\n});\n\n\nfunction nordwindEsController(backend) {\n    var vm = this;\n    vm.link = 'test';\n\n    backend.ready.then(function(){\n\n        backend.getExtraServices().then(function(extraServices){\n            vm.extraServicesList = extraServices.slice();\n            console.log(vm.extraServicesList);\n        });\n\n    });\n\n}\n\n},{}],2:[function(require,module,exports){\n\"use strict\";\nrequire('./screens/add-services/AddServicesScreenController');\nrequire('./screens/search-order/search-order');\nrequire('./components/nordwind-es/nordwind-es');\n\n},{\"./components/nordwind-es/nordwind-es\":1,\"./screens/add-services/AddServicesScreenController\":3,\"./screens/search-order/search-order\":4}],3:[function(require,module,exports){\n\"use strict\";\n'use strict';\n\nangular.module('app').controller('AddServicesScreenController', ['$scope', '$routeParams', '$window', 'redirect', 'backend', 'utils', 'fancyboxTools', function ($scope, $routeParams, $window, redirect, backend, utils, fancyboxTools) {\n    var vm = this;\n\n    vm.loading = true;\n    vm.searchOrderLoading = true;\n    vm.orderServicesLoading = true;\n\n    vm.openOrder = openOrder;\n    vm.submitPayment = submitPayment;\n    vm.paymentFormChangeHandler = paymentFormChangeHandler;\n    vm.reloadPage = reloadPage;\n    vm.clearSession = clearSession;\n\n    $scope.$on('plasticCardForPaymentChangeEvent', function (event, data) {\n        vm.card = data;\n    });\n\n    backend.ready.then(function () {\n        angular.element('title').text(backend.getAliasWithPrefix('web.pageTitle.', 'addServices'));\n\n        vm.pnrOrTicketNumber = $routeParams.pnrOrTicketNumber;\n        vm.lastName = $routeParams.lastName;\n\n        vm.loading = false;\n\n        backend.clearOrderInfoListeners();\n        backend.clearUpdateOrderServicesListeners();\n\n        vm.orderInfo = backend.getOrderInfo();\n\n        if (vm.orderInfo) {\n            orderReadyHandler();\n        } else {\n            backend.searchOrder(vm.pnrOrTicketNumber, vm.lastName, true).then(orderReadyHandler, function (resp) {\n                vm.searchOrderLoading = false;\n                vm.orderServicesLoading = false;\n                vm.errorMessage = resp.error;\n            });\n        }\n\n    });\n\n    function orderReadyHandler() {\n        backend.addOrderInfoListener(function (orderInfo) {\n            vm.orderInfo = orderInfo;\n        });\n\n        backend.addUpdateOrderServicesListener(function (resp) {\n            vm.orderInfo = resp[1];\n            vm.priceVariant = resp[2];\n            vm.isFreePricevariant = utils.isFreePricevariant(resp[2]);\n\n            if (vm.isFreePricevariant) {\n                vm.showNeedSelectPaymentFormMesage = false;\n            }\n\n            vm.es = utils.reformatAvailableExtraServices(resp[0], vm.orderInfo, vm.es);\n            vm.esList = utils.getAvailableExtraServicesList(resp[0], vm.es);\n\n            vm.searchOrderLoading = false;\n            vm.orderServicesLoading = false;\n\n            if (backend.getParam('ffp.enable') && (vm.orderInfo.hasBonusCard || vm.orderInfo.ffpSumm)) {\n                backend.ffpBonus().then(function (resp) {\n                    vm.ffpBonus = resp.total || 0;\n                });\n            }\n        }, function (resp) {\n            vm.searchOrderLoading = false;\n            vm.orderServicesLoading = false;\n            vm.errorMessage = resp.error;\n\n            if (vm.errorMessage === 'web.extraServices.submitError') {\n                vm.showBackButton = true;\n            }\n        });\n\n\n        backend.updateOrderServices(true).then(function () {\n            vm.loading = true;\n\n            backend.switchDefaultSelectedServices(vm.esList, vm.es, vm.orderInfo).then(function () {\n                vm.loading = false;\n            });\n        });\n\n        backend.addExtraServiceListener(function (state) {\n            vm.modifyServicesLoading = !state;\n            vm.orderServicesLoading = true;\n        });\n\n        backend.addExtraServiceErrorListener(function (resp, req) {\n            if (!req || req.code !== 'seat') {\n                vm.modifyServicesError = resp.error;\n            }\n\n            vm.modifyServicesLoading = false;\n            vm.orderServicesLoading = true;\n        });\n    }\n\n    function submitPayment(removeInsuranceAeroexpress) {\n        if (vm.agree && !vm.modifyServicesLoading && !vm.orderServicesLoading) {\n            if (vm.selectedPaymentForm && vm.selectedPaymentType) {\n                if (backend.getParam('site.rossiyaAirlineMode')) {\n                    fancyboxTools.openHandler('popupOrderEmailRequired', false, {\n                        phoneRequiredToo: true,\n                        submitCallback: function submitCallback(email, phone) {\n                            submitPaymentConfirm(removeInsuranceAeroexpress, email, phone);\n                        }\n                    });\n                } else {\n                    submitPaymentConfirm(removeInsuranceAeroexpress);\n                }\n            } else {\n                vm.showNeedSelectPaymentFormMesage = true;\n            }\n        }\n    }\n\n    function submitPaymentConfirm(removeInsuranceAeroexpress, email, phone) {\n        vm.confirmLoading = true;\n\n        if (vm.confirmError) {\n            delete vm.confirmError;\n        }\n\n        backend.startPaymentForExtraServices(vm.selectedPaymentForm, vm.selectedPaymentType, removeInsuranceAeroexpress, email, phone, vm.card).then(function (resp) {\n            if (resp.pnr && resp.lastName) {\n                redirect.goToConfirmOrder(resp.pnr, resp.lastName);\n            } else if (resp.eraseAeroexpressBecauseOfCurrency || resp.eraseInsuranceBecauseOfCurrency) {\n                fancyboxTools.openHandler('popupChangeCurrencyError', false, {\n                    eraseAeroexpressBecauseOfCurrency: resp.eraseAeroexpressBecauseOfCurrency,\n                    eraseInsuranceBecauseOfCurrency: resp.eraseInsuranceBecauseOfCurrency,\n                    mode: 'addServices',\n                    submitCallback: submitPayment\n                });\n            } else if (resp.removedSvcs && resp.removedSvcs.length) {\n                fancyboxTools.openHandler('popupRemovedServicesWarning', false, {\n                    submitCallback: function submitCallback() {\n                        submitPaymentConfirm(removeInsuranceAeroexpress, email, phone);\n                    },\n                    closeCallback: function closeCallback() {\n                        backend.updateOrderServices(true);\n                    },\n\n                    removedSvcs: resp.removedSvcs,\n                    svcsToIssue: resp.svcsToIssue,\n                    noExtraServicesLeft: resp.noExtraServicesLeft,\n                    disableOutsideCloseClick: true\n                });\n            }\n\n            vm.confirmLoading = false;\n        }, function (resp) {\n            if (resp.error === 'web.noBookedConfirmedExtraServices') {\n                vm.fatalError = resp.error;\n            } else {\n                vm.confirmError = resp.error;\n            }\n\n            vm.confirmLoading = false;\n        });\n    }\n\n    function paymentFormChangeHandler() {\n        vm.showNeedSelectPaymentFormMesage = false;\n    }\n\n    function reloadPage() {\n        $window.location.reload();\n        return false;\n    }\n\n    function openOrder(pnrOrTicketNumber, lastName) {\n        if (backend.getParam('site.separatePassengersSearchOrder')) {\n            redirect.goToViewSeparateOrder(pnrOrTicketNumber, lastName);\n        } else {\n            redirect.goToSearchOrder(pnrOrTicketNumber, lastName);\n        }\n    }\n\n    function clearSession() {\n        backend.clearSession().then(function () {\n            redirect.goToSearchOrder();\n        });\n    }\n}]);\n\n},{}],4:[function(require,module,exports){\n\"use strict\";\nangular.module('app').controller(\n    'SearchOrderScreenController',\n    ['$routeParams', 'backend', 'redirect', SearchOrderScreenController]\n);\n\nfunction SearchOrderScreenController($routeParams, backend, redirect) {\n\n    var vm = this;\n    vm.loading = true;\n    vm.searchParams = {};\n    vm.submitSearch = submitSearch;\n    vm.clear = clear;\n\n    backend.ready.then(function () {\n\n        if (backend.getParam('site.rossiyaAirlineMode')) {\n            redirect.goToSearchSeparateOrder();\n            return;\n        }\n\n        angular.element('title').text(backend.getAliasWithPrefix('web.pageTitle.', 'searchOrder'));\n\n        vm.passengerLastNameRegexp = backend.applicationConstants.passengerLastNameRegexp;\n        vm.pnrOrTicketRegexp = backend.applicationConstants.pnrOrTicketRegexp;\n\n        backend.clearOrderInfo();\n        backend.addOrderInfoListener(function () {\n            vm.orderLoaded = true;\n        });\n\n        if ($routeParams.pnrOrTicketNumber && $routeParams.lastName) {\n\n            vm.searchParams.pnrOrTicketNumber = $routeParams.pnrOrTicketNumber;\n            vm.searchParams.lastName = $routeParams.lastName;\n\n            vm.pnrOrTicketNumber = $routeParams.pnrOrTicketNumber;\n            vm.lastName = $routeParams.lastName;\n\n            vm.submitTouched = true;\n\n        }\n\n        vm.loading = false;\n\n    });\n\n    function submitSearch() {\n        vm.submitTouched = true;\n        if (\n            (!backend.getParam('site.useSearchOrderAgreeCheckbox') || vm.searchOrderAgree) &&\n            vm.searchOrderForm.$valid\n        ) {\n            redirect.goToAddServices(vm.searchParams.pnrOrTicketNumber, vm.searchParams.lastName);\n        }\n    }\n\n    function clear() {\n        vm.pnrOrTicketNumber = false;\n        vm.lastName = false;\n    }\n\n}\n\n},{}]},{},[2]);\n"]}