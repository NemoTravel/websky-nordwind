{"version":3,"sources":["controllers-nordwind.js"],"names":["r","e","n","t","o","i","f","c","require","u","a","Error","code","p","exports","call","length","1","module","nordwindEsController","$scope","backend","utils","addInsurance","insuranceEs","_","find","vm","es","service","insurance","active","console","log","items","modifyExtraService","getInsuranceSubmitParams","removeExtraService","onlineMode","item","passenger_id","params","ins","tins","productCode","activateAllServicesByDefault","forEach","handleEsSelect","esCode","selected","closePopup","this","loading","ready","then","addExtraServiceListener","val","updateOrderInfo","resp","orderInfo","getExtraServices","response","extraServicesList","extraServices","slice","reformatAvailableExtraServices","undefined","angular","component","templateUrl","bindings","controllerAs","controller","2","nordwindMealController","3","switchInsuranceCtrl","app","directive","scope","bindToController","4","./components/nordwind-es/nordwind-es","./components/nordwind-meal/nordwind-meal","./directives/switchInsurance","./screens/add-services/AddServicesScreenController","./screens/search-order/search-order","5","$routeParams","$window","redirect","fancyboxTools","orderReadyHandler","addOrderInfoListener","addUpdateOrderServicesListener","priceVariant","isFreePricevariant","showNeedSelectPaymentFormMesage","esList","getAvailableExtraServicesList","searchOrderLoading","orderServicesLoading","getParam","hasBonusCard","ffpSumm","ffpBonus","total","errorMessage","error","showBackButton","updateOrderServices","switchDefaultSelectedServices","state","modifyServicesLoading","addExtraServiceErrorListener","req","modifyServicesError","submitPayment","removeInsuranceAeroexpress","agree","selectedPaymentForm","selectedPaymentType","openHandler","phoneRequiredToo","submitCallback","email","phone","submitPaymentConfirm","confirmLoading","confirmError","startPaymentForExtraServices","card","pnr","lastName","goToConfirmOrder","eraseAeroexpressBecauseOfCurrency","eraseInsuranceBecauseOfCurrency","mode","removedSvcs","closeCallback","svcsToIssue","noExtraServicesLeft","disableOutsideCloseClick","fatalError","paymentFormChangeHandler","reloadPage","location","reload","openOrder","pnrOrTicketNumber","goToViewSeparateOrder","goToSearchOrder","clearSession","$on","event","data","element","text","getAliasWithPrefix","clearOrderInfoListeners","clearUpdateOrderServicesListeners","getOrderInfo","searchOrder","6","SearchOrderScreenController","$timeout","clear","clearOrderInfo","showSearchForm","partiallyAddedPassengers","submitSearch","submitTouched","searchOrderAgree","searchOrderForm","$valid","searchLoading","searchOrderByParams","searchParams","flight","date","needToSpecifyDocument","orderCompletelyInitialized","updateOrderInfoHandler","errorHandler","passengers","confirmHandler","finishSeparatePassengersSearch","addPassenger","passengerLastNameRegexp","applicationConstants","pnrOrTicketRegexp","ticketRegexp"],"mappings":"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","file":"controllers-nordwind.js","sourcesContent":["(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){\n\"use strict\";\nangular.module('app').component('nordwindEs', {\n    templateUrl: 'components/nordwind-es/nordwind-es.html',\n    bindings: {\n        orderInfo: '=',\n        loading: '='\n    },\n    controllerAs: 'vm',\n    controller: 'nordwindEsController'\n});\n\nangular.module('app').controller('nordwindEsController',\n    ['$scope', 'backend', 'utils', nordwindEsController]);\n\n\nfunction nordwindEsController($scope, backend, utils) {\n    var vm = this;\n\n\n    vm.selected = null;\n    vm.handleEsSelect = handleEsSelect;\n    vm.closePopup = closePopup;\n    vm.addInsurance = addInsurance;\n    vm.loading = true;\n\n    backend.ready.then(function () {\n\n        // show additional prices on the flight\n        backend.addExtraServiceListener(function (val) {\n            if (!val) {\n                vm.loading = true;\n            }\n            if (val) {\n                backend.updateOrderInfo().then(function (resp) {\n                    vm.loading = false;\n                    vm.orderInfo = resp;\n                });\n            }\n        });\n\n        backend.getExtraServices().then(function (response) {\n\n            vm.extraServicesList = response.extraServices.slice();\n            vm.es = utils.reformatAvailableExtraServices(response.extraServices.slice(), vm.orderInfo, undefined);\n\n            activateAllServicesByDefault();\n            vm.loading = false;\n        });\n\n    });\n\n    function addInsurance() {\n        var insuranceEs = _.find(vm.es, {code: 'insurance'});\n        vm.service = vm.es.insurance;\n        insuranceEs.active = !insuranceEs.active;\n\n        console.log(insuranceEs);\n        if (insuranceEs.active) {\n            if (insuranceEs.items.length === 1) {\n                backend.modifyExtraService(getInsuranceSubmitParams(insuranceEs.items[0]));\n            }\n        } else {\n            backend.removeExtraService({\n                code: insuranceEs.onlineMode ? 'insuranceOnline' : 'insurance'\n            });\n        }\n    }\n\n\n    function getInsuranceSubmitParams(item, passenger_id) {\n        var params = {\n            code: 'insurance',\n            ins: item.ins,\n            tins: item.tins\n        };\n        if (passenger_id) {\n            params.passenger_id = passenger_id;\n        }\n        if (vm.service.onlineMode) {\n            params.code = 'insuranceOnline';\n            params.productCode = item.productCode;\n        }\n        return params;\n    }\n\n    // по умолчанию все сервисы должны быть открыты\n    // если не вызвать эту функцию в попапе\n    // доп. услуга будет скрыта\n    function activateAllServicesByDefault() {\n        _.forEach(vm.es, function (es) {\n            es.active = true;\n        })\n    }\n\n\n    function handleEsSelect(esCode, service) {\n        vm.selected = esCode;\n    }\n\n    function closePopup() {\n        vm.selected = null;\n    }\n\n}\n\n},{}],2:[function(require,module,exports){\n\"use strict\";\nangular.module('app').component('nordwindMeal', {\n    templateUrl: 'components/nordwind-meal/nordwind-meal.html',\n    bindings: {\n        service: '='\n    },\n    controller: ['backend', nordwindMealController],\n    controllerAs: 'vm'\n});\n\n\nfunction nordwindMealController(backend) {\n    var vm = this;\n\n\n    backend.ready.then(function () {\n\n        backend.getExtraServices().then(function (extraServices) {\n            vm.extraServicesList = extraServices.slice();\n\n        });\n\n    });\n\n\n}\n\n},{}],3:[function(require,module,exports){\n\"use strict\";\nvar app = angular.module('app');\n\n\napp.directive('switchInsurance', function () {\n    return {\n        controller: 'switchInsuranceCtrl',\n        scope: {\n            service: '='\n        },\n        bindToController: true,\n        controllerAs: 'vm',\n    }\n});\n\napp.controller('switchInsuranceCtrl', ['$scope', switchInsuranceCtrl]);\n\nfunction switchInsuranceCtrl($scope) {\n    var vm = this;\n}\n\n\n},{}],4:[function(require,module,exports){\n\"use strict\";\nrequire('./screens/add-services/AddServicesScreenController');\nrequire('./screens/search-order/search-order');\nrequire('./components/nordwind-es/nordwind-es');\nrequire('./components/nordwind-meal/nordwind-meal');\nrequire('./directives/switchInsurance');\n// require('./components/es-meal/es-meal');\n\n\n\n\n\n},{\"./components/nordwind-es/nordwind-es\":1,\"./components/nordwind-meal/nordwind-meal\":2,\"./directives/switchInsurance\":3,\"./screens/add-services/AddServicesScreenController\":5,\"./screens/search-order/search-order\":6}],5:[function(require,module,exports){\n\"use strict\";\n'use strict';\n\nangular.module('app').controller('AddServicesScreenController', ['$scope', '$routeParams', '$window', 'redirect', 'backend', 'utils', 'fancyboxTools', function ($scope, $routeParams, $window, redirect, backend, utils, fancyboxTools) {\n    var vm = this;\n\n    vm.loading = true;\n    vm.searchOrderLoading = true;\n    vm.orderServicesLoading = true;\n\n    vm.openOrder = openOrder;\n    vm.submitPayment = submitPayment;\n    vm.paymentFormChangeHandler = paymentFormChangeHandler;\n    vm.reloadPage = reloadPage;\n    vm.clearSession = clearSession;\n\n    $scope.$on('plasticCardForPaymentChangeEvent', function (event, data) {\n        vm.card = data;\n    });\n\n    backend.ready.then(function () {\n        angular.element('title').text(backend.getAliasWithPrefix('web.pageTitle.', 'addServices'));\n\n        vm.pnrOrTicketNumber = $routeParams.pnrOrTicketNumber;\n        vm.lastName = $routeParams.lastName;\n\n        vm.loading = false;\n\n        backend.clearOrderInfoListeners();\n        backend.clearUpdateOrderServicesListeners();\n\n        vm.orderInfo = backend.getOrderInfo();\n\n        if (vm.orderInfo) {\n            orderReadyHandler();\n        } else {\n            backend.searchOrder(vm.pnrOrTicketNumber, vm.lastName, true).then(orderReadyHandler, function (resp) {\n                vm.searchOrderLoading = false;\n                vm.orderServicesLoading = false;\n                vm.errorMessage = resp.error;\n            });\n        }\n\n    });\n\n    function orderReadyHandler() {\n        backend.addOrderInfoListener(function (orderInfo) {\n            vm.orderInfo = orderInfo;\n        });\n\n        backend.addUpdateOrderServicesListener(function (resp) {\n            vm.orderInfo = resp[1];\n            vm.priceVariant = resp[2];\n            vm.isFreePricevariant = utils.isFreePricevariant(resp[2]);\n\n            if (vm.isFreePricevariant) {\n                vm.showNeedSelectPaymentFormMesage = false;\n            }\n\n            vm.es = utils.reformatAvailableExtraServices(resp[0], vm.orderInfo, vm.es);\n            vm.esList = utils.getAvailableExtraServicesList(resp[0], vm.es);\n\n            vm.searchOrderLoading = false;\n            vm.orderServicesLoading = false;\n\n            if (backend.getParam('ffp.enable') && (vm.orderInfo.hasBonusCard || vm.orderInfo.ffpSumm)) {\n                backend.ffpBonus().then(function (resp) {\n                    vm.ffpBonus = resp.total || 0;\n                });\n            }\n        }, function (resp) {\n            vm.searchOrderLoading = false;\n            vm.orderServicesLoading = false;\n            vm.errorMessage = resp.error;\n\n            if (vm.errorMessage === 'web.extraServices.submitError') {\n                vm.showBackButton = true;\n            }\n        });\n\n\n        backend.updateOrderServices(true).then(function () {\n            vm.loading = true;\n\n            backend.switchDefaultSelectedServices(vm.esList, vm.es, vm.orderInfo).then(function () {\n                vm.loading = false;\n            });\n        });\n\n        backend.addExtraServiceListener(function (state) {\n            vm.modifyServicesLoading = !state;\n            vm.orderServicesLoading = true;\n        });\n\n        backend.addExtraServiceErrorListener(function (resp, req) {\n            if (!req || req.code !== 'seat') {\n                vm.modifyServicesError = resp.error;\n            }\n\n            vm.modifyServicesLoading = false;\n            vm.orderServicesLoading = true;\n        });\n    }\n\n    function submitPayment(removeInsuranceAeroexpress) {\n        if (vm.agree && !vm.modifyServicesLoading && !vm.orderServicesLoading) {\n            if (vm.selectedPaymentForm && vm.selectedPaymentType) {\n                if (backend.getParam('site.rossiyaAirlineMode')) {\n                    fancyboxTools.openHandler('popupOrderEmailRequired', false, {\n                        phoneRequiredToo: true,\n                        submitCallback: function submitCallback(email, phone) {\n                            submitPaymentConfirm(removeInsuranceAeroexpress, email, phone);\n                        }\n                    });\n                } else {\n                    submitPaymentConfirm(removeInsuranceAeroexpress);\n                }\n            } else {\n                vm.showNeedSelectPaymentFormMesage = true;\n            }\n        }\n    }\n\n    function submitPaymentConfirm(removeInsuranceAeroexpress, email, phone) {\n        vm.confirmLoading = true;\n\n        if (vm.confirmError) {\n            delete vm.confirmError;\n        }\n\n        backend.startPaymentForExtraServices(vm.selectedPaymentForm, vm.selectedPaymentType, removeInsuranceAeroexpress, email, phone, vm.card).then(function (resp) {\n            if (resp.pnr && resp.lastName) {\n                redirect.goToConfirmOrder(resp.pnr, resp.lastName);\n            } else if (resp.eraseAeroexpressBecauseOfCurrency || resp.eraseInsuranceBecauseOfCurrency) {\n                fancyboxTools.openHandler('popupChangeCurrencyError', false, {\n                    eraseAeroexpressBecauseOfCurrency: resp.eraseAeroexpressBecauseOfCurrency,\n                    eraseInsuranceBecauseOfCurrency: resp.eraseInsuranceBecauseOfCurrency,\n                    mode: 'addServices',\n                    submitCallback: submitPayment\n                });\n            } else if (resp.removedSvcs && resp.removedSvcs.length) {\n                fancyboxTools.openHandler('popupRemovedServicesWarning', false, {\n                    submitCallback: function submitCallback() {\n                        submitPaymentConfirm(removeInsuranceAeroexpress, email, phone);\n                    },\n                    closeCallback: function closeCallback() {\n                        backend.updateOrderServices(true);\n                    },\n\n                    removedSvcs: resp.removedSvcs,\n                    svcsToIssue: resp.svcsToIssue,\n                    noExtraServicesLeft: resp.noExtraServicesLeft,\n                    disableOutsideCloseClick: true\n                });\n            }\n\n            vm.confirmLoading = false;\n        }, function (resp) {\n            if (resp.error === 'web.noBookedConfirmedExtraServices') {\n                vm.fatalError = resp.error;\n            } else {\n                vm.confirmError = resp.error;\n            }\n\n            vm.confirmLoading = false;\n        });\n    }\n\n    function paymentFormChangeHandler() {\n        vm.showNeedSelectPaymentFormMesage = false;\n    }\n\n    function reloadPage() {\n        $window.location.reload();\n        return false;\n    }\n\n    function openOrder(pnrOrTicketNumber, lastName) {\n        if (backend.getParam('site.separatePassengersSearchOrder')) {\n            redirect.goToViewSeparateOrder(pnrOrTicketNumber, lastName);\n        } else {\n            redirect.goToSearchOrder(pnrOrTicketNumber, lastName);\n        }\n    }\n\n    function clearSession() {\n        backend.clearSession().then(function () {\n            redirect.goToSearchOrder();\n        });\n    }\n}]);\n\n},{}],6:[function(require,module,exports){\n\"use strict\";\n\"use strict\";\n\nangular.module('app').controller(\n    'SearchOrderScreenController',\n    ['$routeParams', 'backend', '$timeout', SearchOrderScreenController]\n);\n\nfunction SearchOrderScreenController($routeParams, backend, $timeout) {\n\n    var vm = this;\n    vm.loading = true;\n    vm.showSearchForm = true;\n    vm.searchParams = {};\n    vm.partiallyAddedPassengers = [];\n    vm.submitSearch = submitSearch;\n    vm.confirmHandler = confirmHandler;\n    vm.clear = clear;\n    vm.addPassenger = addPassenger;\n\n    backend.ready.then(function () {\n\n        angular.element('title').text(backend.getAliasWithPrefix('web.pageTitle.', 'searchOrder'));\n\n        vm.passengerLastNameRegexp = backend.applicationConstants.passengerLastNameRegexp;\n        vm.pnrOrTicketRegexp = backend.applicationConstants.pnrOrTicketRegexp;\n        vm.ticketRegexp = backend.applicationConstants.ticketRegexp;\n\n        if ($routeParams.pnrOrTicketNumber && $routeParams.lastName && backend.getParam('site.searchOrdersBy') === 'LAST_NAME_PNR_TICKET') {\n            vm.searchParams.pnrOrTicketNumber = $routeParams.pnrOrTicketNumber;\n            vm.searchParams.lastName = $routeParams.lastName;\n            vm.loading = false;\n            $timeout(submitSearch);\n        } else {\n            updateOrderInfoHandler();\n        }\n    });\n\n    function clear() {\n        backend.clearSession();\n        backend.clearOrderInfo();\n        vm.orderInfo = false;\n        vm.showSearchForm = true;\n        vm.partiallyAddedPassengers = [];\n    }\n\n    function submitSearch() {\n        vm.submitTouched = true;\n        if ((!backend.getParam('site.useSearchOrderAgreeCheckbox') || vm.searchOrderAgree) && vm.searchOrderForm.$valid) {\n            vm.searchLoading = true;\n            vm.errorMessage = false;\n            backend.searchOrderByParams(vm.searchParams, !!vm.partiallyAddedPassengers.length).then(function (resp) {\n                if (vm.searchParams.flight && vm.searchParams.date) {\n                    vm.searchParams = {\n                        flight: vm.searchParams.flight,\n                        date: vm.searchParams.date\n                    };\n                } else if (!resp.needToSpecifyDocument) {\n                    vm.searchParams = {};\n                }\n                vm.needToSpecifyDocument = resp.needToSpecifyDocument;\n                vm.showSearchForm = false;\n                vm.submitTouched = false;\n                if (resp.orderCompletelyInitialized) {\n                    vm.partiallyAddedPassengers = [];\n                    updateOrderInfoHandler();\n                } else {\n                    if (resp.partiallyAddedPassengers) {\n                        vm.partiallyAddedPassengers = resp.partiallyAddedPassengers;\n                    }\n                    if (vm.needToSpecifyDocument) {\n                        vm.showSearchForm = true;\n                    }\n                }\n                vm.searchLoading = false;\n            }, errorHandler);\n        }\n    }\n\n    function updateOrderInfoHandler() {\n        backend.updateOrderInfo().then(function (orderInfo) {\n            if (orderInfo.passengers) {\n                vm.orderInfo = orderInfo;\n                vm.showSearchForm = false;\n            }\n            vm.loading = false;\n        }, errorHandler);\n    }\n\n    function errorHandler(resp) {\n        vm.loading = false;\n        vm.searchLoading = false;\n        if (resp.error !== 'web.messages.emptyOrder') {\n            vm.errorMessage = resp.error;\n        }\n    }\n\n    function confirmHandler() {\n        backend.finishSeparatePassengersSearch().then(updateOrderInfoHandler, errorHandler);\n    }\n\n    function addPassenger() {\n        vm.showSearchForm = true;\n    }\n}\n\n},{}]},{},[4]);\n"]}